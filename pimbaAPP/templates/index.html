{% extends 'base.html' %}

{% block extrahead %}
{% endblock %}
{% block contenido %}
    <div class="row" style="margin-top: 35px">
        <div class="col-md-2"></div>
        <div class="col-md-8 border">
            <form id="formulario" enctype="multipart/form-data">
                <h1>Sube una imagen para predecir</h1>
                <div class="form-group">
                     {% csrf_token %}
                    <input id="imagen" name="imagen" accept="image/*" alt="subir-imagen"  type="file" required>
                </div>
                <div class="d-flex justify-content-center">
                    <button id="predecir" type="submit" class="p-2 btn btn-info" style="margin-top: 15px">Predecir</button>
                </div>
            </form>
        </div>
        <div class="col-md-2"></div>
    </div>
    <div class="row" style="margin-top: 25px">
        <div class="col-md-2"></div>
        <div class="col-md-8" id="resultados"></div>
        <div class="col-md-2"></div>
    </div>

{% endblock %}

{% block extrajs %}
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>
        $('#formulario').on('submit',
            (e)=>{
                e.preventDefault();
                mostrar_animacion_esperar_resultados();
                let datos = new FormData();
                datos.append('imagen', $('input[type=file]')[0].files[0],'imagen');
                $.ajax({
                    url         : '/api/v1/predecir',
                    data        : datos,
                    type        : 'POST',
                    processData: false,
                    contentType: false,
                    success     :
                        (data)=>{
                            console.log(data);
                            mostrar_resultados(data)
                        }
                });
            }
        );
        function mostrar_animacion_esperar_resultados() {
            let cuadro_resultados = $('#resultados');
            cuadro_resultados.empty();
            cuadro_resultados.attr('class','border');
            cuadro_resultados.append('<h1>Resultados</h1>');
            mostrar_animacion_cargando();
        }

        function mostrar_resultados(data) {
            remover_animacion_cargando();
            $('#resultados').append(render_resultados(data))
        }

        function render_resultados(data) {
            return `<image src=${data.imagen} width="128" height="128"/><ul><li>Descripcion: ${data.descripcion}</li><li>Porcentaje: ${data.precision}</li></ul>`
        }

        function remover_animacion_cargando() {
            $("#loader").remove();
        }
        function mostrar_animacion_cargando() {
        if ($("#loader")){
            remover_animacion_cargando();
        }
        $("#resultados").append('<div id="loader" class="d-flex justify-content-center">'+
            '<div class="p-2">'+
            '<div  class="spinner-grow" role="status">'+
            '<span class="sr-only">Loading...</span>'+
            '</div><div  class="spinner-grow" role="status">'+
            '<span class="sr-only">Loading...</span>'+
            '</div>' +
            '<div  class="spinner-grow" role="status">'+
            '<span class="sr-only">Loading...</span>'+
            '</div>' +
            '</div>' +
            '</div>');
    }
    </script>
{% endblock %}