{% extends 'base.html' %}

{% block extrahead %}
    <style>
         .titulo{
             border-bottom: 6px solid #082713;
         }
    </style>
{% endblock %}
{% block contenido %}
    <div class="row" style="margin-top: 35px">
        <div class="col-md-2"></div>
        <div class="col-md-8 border">
                <div class="row" style="background-color: rgba(0, 0, 0, 0.7);">
                    <div class="col-md-1"></div>
                    <div class="col-md-10">
                        <h1 class="text-white">Sube una imagen para predecir</h1>
                    </div>
                    <div class="col-md-1"></div>
                </div>
            <form id="formulario" enctype="multipart/form-data" style="margin-top: 20px">
                <div class="form-group">
                     {% csrf_token %}
                    <input id="imagen" name="imagen" accept="image/*" alt="subir-imagen"  type="file" required>
                </div>
                <div class="d-flex justify-content-center">
                    <button id="predecir" type="submit" class="p-2 btn btn-danger" style="margin-top: 15px">Predecir</button>
                </div>
            </form>
        </div>
        <div class="col-md-2"></div>
    </div>
    <div class="row" style="margin-top: 25px">
        <div class="col-md-2"></div>
        <div class="col-md-8" style="padding-bottom: 25px;" id="resultados">

        </div>
        <div class="col-md-2"></div>
    </div>

{% endblock %}

{% block extrajs %}
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>
        $('#formulario').on('submit',
            (e)=>{
                e.preventDefault();
                mostrar_animacion_esperar_resultados();
                let datos = new FormData();
                datos.append('imagen', $('input[type=file]')[0].files[0],'imagen');
                $.ajax({
                    url         : '/api/v1/predecir',
                    data        : datos,
                    type        : 'POST',
                    processData: false,
                    contentType: false,
                    success     :
                        (data)=>{
                            console.log(data);
                            mostrar_resultados(data)
                        }
                });
            }
        );
        function mostrar_animacion_esperar_resultados() {
            let cuadro_resultados = $('#resultados');
            cuadro_resultados.empty();
            cuadro_resultados.append('<div class="row border" style="background-color: rgba(0, 0, 0, 0.7);">' +
                '<div class="col-md-1"></div>' +
                '<div class="col-md-10"><h1 class="text-white">Resultados:</h1></div>' +
                '<div class="col-md-1"></div></div>');
            mostrar_animacion_cargando();
        }

        function mostrar_resultados(data) {
            remover_animacion_cargando();
            $('#resultados').append(render_resultados(data))
        }

        function render_resultados(data) {
            return `<div class="d-flex flex-row justify-content-center">
                        <div class="card class="p-2" style="width: 18rem;">
                           <img class="card-img-top" src=${data.imagen} alt="Card image cap">
                           <div class="card-body bg-dark text-white">
                                <h5 class="card-title titulo">Prediccion</h5>
                                <p class="card-text">La imagen es: ${data.descripcion}</p>
                                <p class="card-text">Confiabilidad: ${data.precision.toFixed(2)}%</p>
                            </div>
                        </div>
                    </div>`
        }

        function remover_animacion_cargando() {
            $("#loader").remove();
        }
        function mostrar_animacion_cargando() {
        if ($("#loader")){
            remover_animacion_cargando();
        }
        $("#resultados").append('<div id="loader" class="p-2 d-flex justify-content-center">'+
            '<div class="p-2">'+
            '<div  class="spinner-grow" role="status">'+
            '<span class="sr-only">Loading...</span>'+
            '</div><div  class="spinner-grow" role="status">'+
            '<span class="sr-only">Loading...</span>'+
            '</div>' +
            '<div  class="spinner-grow" role="status">'+
            '<span class="sr-only">Loading...</span>'+
            '</div>' +
            '</div>' +
            '</div>');
    }
    </script>
{% endblock %}